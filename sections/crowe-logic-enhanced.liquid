{% comment %}
  Enhanced Crowe Logicâ„¢ AI Panel Section
  Embedded React app with voice synthesis and checkout integration
{% endcomment %}

<style>
  .crowe-logic-section {
    background: linear-gradient(135deg, var(--clr-bg-dark) 0%, rgba(23, 20, 30, 0.9) 100%);
    color: var(--clr-text);
    padding: var(--spacing-section) 0;
    margin: var(--spacing-section) 0;
    border-radius: var(--radius-xl);
    overflow: hidden;
    position: relative;
  }
  
  .crowe-logic-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(198,163,81,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
    pointer-events: none;
  }
  
  .crowe-logic-container {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-component);
  }
  
  .crowe-logic-header {
    text-align: center;
    margin-bottom: var(--spacing-section);
  }
  
  .crowe-logic-title {
    color: var(--clr-accent);
    font-size: var(--text-4xl);
    margin-bottom: var(--spacing-element);
    font-weight: var(--font-weight-bold);
  }
  
  .crowe-logic-subtitle {
    color: var(--clr-text);
    opacity: 0.9;
    font-size: var(--text-lg);
    max-width: 600px;
    margin: 0 auto;
    line-height: var(--line-height-relaxed);
  }
  
  .crowe-logic-iframe-container {
    background: var(--clr-fg-light);
    border-radius: var(--radius-lg);
    padding: 2px;
    box-shadow: var(--shadow-xl);
    margin: var(--spacing-section) 0;
    overflow: hidden;
  }
  
  .crowe-logic-fallback {
    background: var(--clr-fg-light);
    color: var(--clr-black);
    padding: var(--spacing-section);
    border-radius: var(--radius-lg);
    text-align: center;
    box-shadow: var(--shadow-base);
  }
  
  .crowe-logic-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-component);
    margin-top: var(--spacing-section);
  }
  
  .feature-card {
    background: rgba(244, 244, 242, 0.1);
    padding: var(--spacing-component);
    border-radius: var(--radius-lg);
    border: 1px solid var(--clr-accent);
    transition: all var(--transition-base);
  }
  
  .feature-card:hover {
    background: rgba(198, 163, 81, 0.1);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }
  
  .feature-icon {
    width: 48px;
    height: 48px;
    background: var(--clr-accent);
    color: var(--clr-black);
    border-radius: var(--radius-base);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--spacing-element);
    font-size: 24px;
  }
  
  .feature-title {
    color: var(--clr-accent);
    font-size: var(--text-lg);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--spacing-tight);
  }
  
  .feature-description {
    color: var(--clr-text);
    opacity: 0.9;
    font-size: var(--text-sm);
    line-height: var(--line-height-relaxed);
  }
  
  .crowe-logic-cta {
    text-align: center;
    margin-top: var(--spacing-section);
  }
  
  .crowe-logic-cta .btn {
    margin: 0 var(--spacing-tight);
  }
  
  @media screen and (max-width: 768px) {
    .crowe-logic-title {
      font-size: var(--text-3xl);
    }
    
    .crowe-logic-features {
      grid-template-columns: 1fr;
    }
    
    .crowe-logic-cta .btn {
      display: block;
      margin: var(--spacing-tight) 0;
      width: 100%;
    }
  }
</style>

<section class="crowe-logic-section">
  <div class="crowe-logic-container">
    <!-- Section Header -->
    <div class="crowe-logic-header">
      <h2 class="crowe-logic-title">{{ section.settings.title | default: "Crowe Logicâ„¢ AI Assistant" }}</h2>
      <p class="crowe-logic-subtitle">
        {{ section.settings.subtitle | default: "Experience myco-intelligent commerce with voice-powered AI guidance, personalized recommendations, and seamless integration across the regenerative ecosystem." }}
      </p>
    </div>
    
    <!-- AI Panel iframe -->
    {% if section.settings.app_url != blank %}
      <div class="crowe-logic-iframe-container">
        <iframe 
          src="{{ section.settings.app_url }}"
          class="crowe-logic-iframe"
          width="100%" 
          height="{{ section.settings.iframe_height | default: 750 }}"
          frameborder="0"
          loading="lazy"
          allow="microphone; camera; clipboard-write"
          sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
          aria-label="Crowe Logic AI Assistant Interface">
        </iframe>
      </div>
    {% else %}
      <div class="crowe-logic-fallback">
        <div class="crowe-logic-placeholder">
          <div style="width: 120px; height: 120px; margin: 0 auto var(--spacing-component); background: var(--clr-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
              <path d="M9 12l2 2 4-4"/>
            </svg>
          </div>
          <h3 style="color: var(--clr-accent); margin-bottom: var(--spacing-element);">AI Assistant Loading...</h3>
          <p style="margin-bottom: var(--spacing-component);">Configure your Crowe Logic app URL in the theme settings to enable the full AI experience.</p>
          <a href="/admin/themes/current/editor?context=theme&category=sections&target=section-groups%2Fheader%2Fsections%2Fcrowe-logic.liquid" class="btn">
            Configure Settings
          </a>
        </div>
      </div>
    {% endif %}
    
    <!-- Feature Grid -->
    <div class="crowe-logic-features">
      <div class="feature-card animate-fade-in-up">
        <div class="feature-icon">ðŸ§ </div>
        <h3 class="feature-title">Myco-Intelligence</h3>
        <p class="feature-description">
          Advanced AI trained on mycological data, cultivation techniques, and regenerative commerce principles.
        </p>
      </div>
      
      <div class="feature-card animate-fade-in-up" style="animation-delay: 0.1s;">
        <div class="feature-icon">ðŸŽ¤</div>
        <h3 class="feature-title">Voice Synthesis</h3>
        <p class="feature-description">
          Natural voice interaction with ElevenLabs integration for seamless audio conversations.
        </p>
      </div>
      
      <div class="feature-card animate-fade-in-up" style="animation-delay: 0.2s;">
        <div class="feature-icon">ðŸ›’</div>
        <h3 class="feature-title">Smart Commerce</h3>
        <p class="feature-description">
          Personalized product recommendations and one-click checkout integration with your cart.
        </p>
      </div>
      
      <div class="feature-card animate-fade-in-up" style="animation-delay: 0.3s;">
        <div class="feature-icon">ðŸ“±</div>
        <h3 class="feature-title">Cross-Platform</h3>
        <p class="feature-description">
          Seamless experience across Shopify, React apps, and mobile devices with responsive design.
        </p>
      </div>
    </div>
    
    <!-- Call to Action -->
    {% if section.settings.show_cta %}
      <div class="crowe-logic-cta">
        {% if section.settings.cta_primary_text != blank %}
          <a href="{{ section.settings.cta_primary_url | default: '#crowe-logic-iframe' }}" class="btn">
            {{ section.settings.cta_primary_text }}
          </a>
        {% endif %}
        
        {% if section.settings.cta_secondary_text != blank %}
          <a href="{{ section.settings.cta_secondary_url | default: '/pages/ai-guide' }}" class="btn btn--secondary">
            {{ section.settings.cta_secondary_text }}
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle iframe communication for checkout integration
    window.addEventListener('message', function(event) {
      // Verify origin for security
      const allowedOrigins = [
        'https://crowe-logic.vercel.app',
        'https://localhost:3000',
        'http://localhost:3000'
      ];
      
      if (!allowedOrigins.includes(event.origin)) return;
      
      const data = event.data;
      
      // Handle checkout requests from the iframe
      if (data.type === 'CHECKOUT_REQUEST' && data.products) {
        handleCheckoutRequest(data.products);
      }
      
      // Handle height adjustments
      if (data.type === 'RESIZE_IFRAME' && data.height) {
        const iframe = document.querySelector('.crowe-logic-iframe');
        if (iframe) {
          iframe.style.height = data.height + 'px';
        }
      }
      
      // Handle navigation requests
      if (data.type === 'NAVIGATE' && data.url) {
        window.location.href = data.url;
      }
    });
    
    function handleCheckoutRequest(products) {
      // Convert products to Shopify cart format
      const cartItems = products.map(product => ({
        id: product.variantId || product.id,
        quantity: product.quantity || 1,
        properties: product.properties || {}
      }));
      
      // Add to Shopify cart
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          items: cartItems
        })
      })
      .then(response => response.json())
      .then(data => {
        // Redirect to cart or show success message
        window.location.href = '/cart';
      })
      .catch(error => {
        console.error('Checkout error:', error);
        alert('There was an error adding items to your cart. Please try again.');
      });
    }
    
    // Animate feature cards on scroll
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }
      });
    }, observerOptions);
    
    document.querySelectorAll('.feature-card').forEach(card => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(30px)';
      card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
      observer.observe(card);
    });
  });
</script>

{% schema %}
{
  "name": "Crowe Logic AI Panel",
  "settings": [
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Crowe Logicâ„¢ AI Assistant"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Section Subtitle",
      "default": "Experience myco-intelligent commerce with voice-powered AI guidance, personalized recommendations, and seamless integration across the regenerative ecosystem."
    },
    {
      "type": "header",
      "content": "App Integration"
    },
    {
      "type": "url",
      "id": "app_url",
      "label": "Crowe Logic App URL",
      "info": "URL of your deployed React app (e.g., https://crowe-logic.vercel.app)"
    },
    {
      "type": "range",
      "id": "iframe_height",
      "label": "iframe Height (px)",
      "min": 400,
      "max": 1000,
      "step": 50,
      "default": 750
    },
    {
      "type": "header",
      "content": "Call to Action"
    },
    {
      "type": "checkbox",
      "id": "show_cta",
      "label": "Show Call to Action Buttons",
      "default": true
    },
    {
      "type": "text",
      "id": "cta_primary_text",
      "label": "Primary CTA Text",
      "default": "Launch AI Assistant"
    },
    {
      "type": "url",
      "id": "cta_primary_url",
      "label": "Primary CTA URL"
    },
    {
      "type": "text",
      "id": "cta_secondary_text",
      "label": "Secondary CTA Text",
      "default": "Learn More"
    },
    {
      "type": "url",
      "id": "cta_secondary_url",
      "label": "Secondary CTA URL",
      "default": "/pages/ai-guide"
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section Width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "full-width",
          "label": "Full width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding Top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding Bottom", 
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Crowe Logic AI Panel",
      "settings": {
        "title": "Crowe Logicâ„¢ AI Assistant",
        "subtitle": "Experience myco-intelligent commerce with voice-powered AI guidance.",
        "show_cta": true,
        "cta_primary_text": "Launch AI Assistant",
        "cta_secondary_text": "Learn More"
      }
    }
  ]
}
{% endschema %}
